<!DOCTYPE HTML>
<html lang="zh">
<head>
<!-- Generated by javadoc (21) on Sun Aug 03 22:06:08 CST 2025 -->
<title>com.iohao.game.common.kit.concurrent.timer.delay (ioGame 21.29 API)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="dc.created" content="2025-08-03">
<meta name="description" content="declaration: package: com.iohao.game.common.kit.concurrent.timer.delay">
<meta name="generator" content="javadoc/PackageWriterImpl">
<link rel="stylesheet" type="text/css" href="../../../../../../../../stylesheet.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../../../../../script-dir/jquery-ui.min.css" title="Style">
<script type="text/javascript" src="../../../../../../../../script.js"></script>
<script type="text/javascript" src="../../../../../../../../script-dir/jquery-3.6.1.min.js"></script>
<script type="text/javascript" src="../../../../../../../../script-dir/jquery-ui.min.js"></script>
</head>
<body class="package-declaration-page">
<script type="text/javascript">var pathtoroot = "../../../../../../../../";
loadScripts(document, 'script');</script>
<noscript>
<div>您的浏览器已禁用 JavaScript。</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top"><button id="navbar-toggle-button" aria-controls="navbar-top" aria-expanded="false" aria-label="切换导航链接"><span class="nav-bar-toggle-icon">&nbsp;</span><span class="nav-bar-toggle-icon">&nbsp;</span><span class="nav-bar-toggle-icon">&nbsp;</span></button>
<div class="skip-nav"><a href="#skip-navbar-top" title="跳过导航链接">跳过导航链接</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="导航">
<li><a href="../../../../../../../../index.html">概览</a></li>
<li class="nav-bar-cell1-rev">程序包</li>
<li>类</li>
<li><a href="package-use.html">使用</a></li>
<li><a href="package-tree.html">树</a></li>
<li><a href="../../../../../../../../deprecated-list.html">已过时</a></li>
<li><a href="../../../../../../../../index-all.html">索引</a></li>
<li><a href="../../../../../../../../help-doc.html#package">帮助</a></li>
</ul>
<ul class="sub-nav-list-small">
<li>
<p>程序包：</p>
<ul>
<li><a href="#package-description">说明</a></li>
<li>相关程序包</li>
<li><a href="#class-summary">类和接口</a></li>
</ul>
</li>
</ul>
</div>
<div class="sub-nav">
<div id="navbar-sub-list">
<ul class="sub-nav-list">
<li>程序包：&nbsp;</li>
<li><a href="#package-description">说明</a>&nbsp;|&nbsp;</li>
<li>相关程序包&nbsp;|&nbsp;</li>
<li><a href="#class-summary">类和接口</a></li>
</ul>
</div>
<div class="nav-list-search"><a href="../../../../../../../../search.html">SEARCH</a>
<input type="text" id="search-input" disabled placeholder="搜索">
<input type="reset" id="reset-button" disabled value="reset">
</div>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main">
<div class="header">
<h1 title="程序包 com.iohao.game.common.kit.concurrent.timer.delay" class="title">程序包 com.iohao.game.common.kit.concurrent.timer.delay</h1>
</div>
<hr>
<div class="package-signature">package <span class="element-name">com.iohao.game.common.kit.concurrent.timer.delay</span></div>
<section class="package-description" id="package-description">
<div class="block">工具相关 - <a href="https://iohao.github.io/game/docs/kit/delay_task">轻量可控的延时任务</a>，任务到达指定时间后会执行、任务可取消、任务可增加或减少延时时间、任务可被覆盖、可设置任务监听回调。
 <p>
 轻量可控的延时任务 - 简介
 <pre>
     我们知道，在 <a href="../../TaskKit.html" title="com.iohao.game.common.kit.concurrent中的类"><code>TaskKit</code></a> 中，提供了一个任务、时间、延时监听、超时监听 ...等相结合的一个工具模块，通过 runOnce 可以执行一些延时任务；
     但有时，我们需要一些可控的延时任务，也就是延时时间可以根据后续的业务来变化，比如增加或减少延时的时间、取消任务 ...等可控的操作。
 </pre>
 轻量可控的延时任务 - 特点
 <pre>
     1. 单一职责原则
     2. 任务到达指定时间后会执行
     3. 任务可取消
     4. 任务可被覆盖
     5. 任务可增加、减少延时的时间
     6. 可设置任务监听回调
     7. 内部使用 Netty HashedWheelTimer，轻松支持百万任务。
 </pre>
 for example
 <pre><code>
 public class DelayTaskTest {
     @Test
     public void runDelayTask() {
         // ---------------演示 - 延时任务---------------
         // 1 秒后执行延时任务
         DelayTaskKit.of(() -&gt; {
                     log.info("1 秒后执行的延时任务");
                 })
                 .plusTime(Duration.ofSeconds(1)) // 增加 1 秒的延时
                 .task(); // 启动任务
     }

     @Test
     public void plusDelayTime() {
         // ---------------演示 - 增加延时时间---------------
         long timeMillis = System.currentTimeMillis();

         DelayTask delayTask = DelayTaskKit.of(() -&gt; {
                     long value = System.currentTimeMillis() - timeMillis;
                     log.info("增加延时时间，最终 {} ms 后，执行延时任务", value);
                     // Assert.assertTrue(value &gt; 1490);
                 })
                 .plusTime(Duration.ofSeconds(1)) // 增加 1 秒的延时
                 .task(); // 启动任务

         delayTask.plusTimeMillis(500); // 增加 0.5 秒的延时

         // 最终 1.5 秒后执行延时任务
     }

     @Test
     public void minusDelayTime() {
         // ---------------演示 - 减少延时时间---------------
         long timeMillis = System.currentTimeMillis();

         // 1 秒后执行延时任务
         DelayTask delayTask = DelayTaskKit.of(() -&gt; {
                     long value = System.currentTimeMillis() - timeMillis;
                     log.info("减少延时时间，最终 {} ms 后，执行延时任务", value);
                     // Assert.assertTrue(value &lt; 510);
                 })
                 .plusTime(Duration.ofSeconds(1)) // 增加 1 秒的延时
                 .task(); // 启动任务

         delayTask.minusTimeMillis(500); // 减少 0.5 秒的延时时间

         // 最终 0.5 秒后执行延时任务
     }

     @Test
     public void coverDelayTask() throws InterruptedException {
         // ---------------演示 - 覆盖延时任务---------------

         String taskId = "1";

         DelayTaskKit.of(taskId, () -&gt; log.info("执行任务 - 1"))
                 .plusTime(Duration.ofSeconds(2)) // 增加 2 秒的延时
                 .task(); // 启动任务

         TimeUnit.MILLISECONDS.sleep(500);

         long timeMillis = System.currentTimeMillis();

         // 因为 taskId 相同，所以会覆盖之前的延时任务
         DelayTask delayTask = DelayTaskKit.of(taskId, () -&gt; {
                     long value = System.currentTimeMillis() - timeMillis;
                     log.info("执行任务 - 2，最终 {} ms 后，执行延时任务", value);
                     // Assert.assertTrue(value &gt; 990);
                 })
                 .plusTime(Duration.ofSeconds(1)) // 增加 1 秒的延时
                 .task(); // 启动任务
     }

     @Test
     public void cancelDelayTask() throws InterruptedException {
         // ---------------演示 - 取消延时任务，通过 DelayTask 来取消---------------

         DelayTask delayTask = DelayTaskKit.of(() -&gt; {
                     log.info("取消 - 延时任务");
                 })
                 .plusTime(Duration.ofSeconds(2)) // 增加 2 秒的延时
                 .task(); // 启动任务

         log.info("0.5 秒后, 因为满足某个业务条件, 不想执行定时任务了");
         TimeUnit.MILLISECONDS.sleep(500);

         delayTask.isActive(); // true
         delayTask.cancel(); // 取消任务
         delayTask.isActive(); // false

         // -----------演示 - 取消延时任务，通过 taskId 来取消-----------

         String taskId = "1";
         // 在创建延时任务时，设置 taskId
         DelayTaskKit.of(taskId, () -&gt; log.info("通过 taskId 取消 - 延时任务"))
                 .plusTime(Duration.ofSeconds(1)) // 增加 1 秒的延时
                 .task(); // 启动任务

         log.info("0.5 秒后, 因为满足某个业务条件, 不想执行定时任务了");
         TimeUnit.MILLISECONDS.sleep(500);
         DelayTaskKit.cancel(taskId); // 通过 taskId 取消任务
     }

     @Test
     public void optionalDelayTask() {
         // ---------------演示 - 查找延时任务---------------

         String newTaskId = "1";
         DelayTaskKit.of(newTaskId, () -&gt; log.info("hello DelayTask"))
                 // 2.5 秒后执行延时任务。（这里演示添加延时时间的两个方法）
                 .plusTime(Duration.ofSeconds(1)) // 增加 1 秒的延时
                 .plusTime(Duration.ofMillis(1000)) // 增加 1 秒的延时
                 .plusTimeMillis(500) // 增加 0.5 秒的延时
                 .task(); // 启动任务

         // 在后续的业务中，可以通过 taskId 查找该延时任务
         Optional&lt;DelayTask&gt; optionalDelayTask = DelayTaskKit.optional(newTaskId);
         if (optionalDelayTask.isPresent()) {
             DelayTask delayTask = optionalDelayTask.get();
             log.info("{}", delayTask);
         }

         // 通过 taskId 查找延时任务，存在则执行给定逻辑
         DelayTaskKit.ifPresent(newTaskId, delayTask -&gt; {
             delayTask.plusTimeMillis(500); // 增加 0.5 秒的延时时间
         });
     }

     @Test
     public void customTaskListener() {
         // ---------------演示 - 增强 TaskListener ---------------

         DelayTaskKit.of(new TaskListener() {
                     @Override
                     public void onUpdate() {
                         log.info("1.7 秒后执行的延时任务");
                     }

                     @Override
                     public boolean triggerUpdate() {
                         // 是否触发 onUpdate 监听回调方法
                         return TaskListener.super.triggerUpdate();
                     }

                     @Override
                     public Executor getExecutor() {
                         // 指定一个执行器来消费当前 onUpdate
                         Executors yourExecutors = ...;
                         return yourExecutors;
                     }

                     @Override
                     public void onException(Throwable e) {
                         // 异常回调
                         TaskListener.super.onException(e);
                     }
                 })
                 .plusTime(Duration.ofMillis(1700))
                 .task();
     }
 }
 </code>
 </pre></div>
<dl class="notes">
<dt>从以下版本开始:</dt>
<dd>21.16</dd>
<dt>作者:</dt>
<dd>渔民小镇</dd>
<dt>日期:</dt>
<dd>2024-09-01</dd>
</dl>
</section>
<section class="summary">
<ul class="summary-list">
<li>
<div id="class-summary">
<div class="table-tabs" role="tablist" aria-orientation="horizontal"><button id="class-summary-tab0" role="tab" aria-selected="true" aria-controls="class-summary.tabpanel" tabindex="0" onkeydown="switchTab(event)" onclick="show('class-summary', 'class-summary', 2)" class="active-table-tab">所有类和接口</button><button id="class-summary-tab1" role="tab" aria-selected="false" aria-controls="class-summary.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('class-summary', 'class-summary-tab1', 2)" class="table-tab">接口</button><button id="class-summary-tab2" role="tab" aria-selected="false" aria-controls="class-summary.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('class-summary', 'class-summary-tab2', 2)" class="table-tab">类</button></div>
<div id="class-summary.tabpanel" role="tabpanel">
<div class="summary-table two-column-summary" aria-labelledby="class-summary-tab0">
<div class="table-header col-first">类</div>
<div class="table-header col-last">说明</div>
<div class="col-first even-row-color class-summary class-summary-tab1"><a href="DelayTask.html" title="com.iohao.game.common.kit.concurrent.timer.delay中的接口">DelayTask</a></div>
<div class="col-last even-row-color class-summary class-summary-tab1">
<div class="block"><a href="https://iohao.github.io/game/docs/kit/delay_task">轻量可控的延时任务</a>，任务到达指定时间后会执行、任务可取消、任务可增加延时时间</div>
</div>
<div class="col-first odd-row-color class-summary class-summary-tab2"><a href="DelayTaskKit.html" title="com.iohao.game.common.kit.concurrent.timer.delay中的类">DelayTaskKit</a></div>
<div class="col-last odd-row-color class-summary class-summary-tab2">
<div class="block">轻量可控的延时任务工具类</div>
</div>
<div class="col-first even-row-color class-summary class-summary-tab1"><a href="DelayTaskRegion.html" title="com.iohao.game.common.kit.concurrent.timer.delay中的接口">DelayTaskRegion</a></div>
<div class="col-last even-row-color class-summary class-summary-tab1">
<div class="block">轻量可控延时任务域接口，负责轻量可控延时任务的创建、获取、取消、统计任务数量 ...等相关操作。</div>
</div>
</div>
</div>
</div>
</li>
</ul>
</section>
</main>
<footer role="contentinfo">
<hr>
<p class="legal-copy"><small>Copyright &#169; 2025. All rights reserved.</small></p>
</footer>
</div>
</div>
</body>
</html>
