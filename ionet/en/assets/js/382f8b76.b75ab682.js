"use strict";(self.webpackChunkionet_doc=self.webpackChunkionet_doc||[]).push([[5619],{628:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>o,contentTitle:()=>a,default:()=>x,frontMatter:()=>s,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"communication/on_external","title":"OnExternal","description":"\u4ecb\u7ecd","source":"@site/docs/communication/on_external.mdx","sourceDirName":"communication","slug":"/communication/on_external","permalink":"/ionet/en/docs/communication/on_external","draft":false,"unlisted":false,"editUrl":"/docs/communication/on_external.mdx","tags":[],"version":"current","lastUpdatedAt":1763006439000,"sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"broadcast","permalink":"/ionet/en/docs/communication/broadcast"},"next":{"title":"request/multiple_response","permalink":"/ionet/en/docs/communication/request_multiple_response"}}');var r=t(4848),i=t(8453);const s={sidebar_position:5},a="OnExternal",o={},c=[{value:"\u4ecb\u7ecd",id:"Intro",level:2},{value:"Example Source Code",id:"example-source-code",level:2},{value:"\u5982\u4f55\u6269\u5c55",id:"How-to-Extend",level:2},{value:"\u914d\u7f6e",id:"config",level:2},{value:"\u5982\u4f55\u4f7f\u7528",id:"How-to-Use",level:2},{value:"\u7edf\u8ba1\u5728\u7ebf\u4eba\u6570",id:"UserOnlineCountOnExternal",level:2},{value:"\u5982\u4f55\u8bbe\u7f6e\u8bf7\u6c42\u53c2\u6570",id:"Setting-Request-Parameters",level:2},{value:"\u5c0f\u7ed3",id:"summary",level:2}];function d(n){const e={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"onexternal",children:"OnExternal"})}),"\n",(0,r.jsx)(e.h2,{id:"Intro",children:"\u4ecb\u7ecd"}),"\n",(0,r.jsxs)(e.p,{children:["\u8bbf\u95ee\u5bf9\u5916\u670d\u4e0e\u6269\u5c55\uff0c\u662f\u6846\u67b6\u63d0\u4f9b\u7684\u901a\u4fe1\u65b9\u5f0f\u4e4b\u4e00\uff0c\u4e3b\u8981\u7528\u4e8e\u903b\u8f91\u670d\u4e0e\u5bf9\u5916\u670d\u7684\u4ea4\u4e92\u4e0a\u3002\n\u672c\u7bc7\u4ecb\u7ecd\u5982\u4f55\u4ece",(0,r.jsx)(e.a,{href:"/docs/manual/external_intro",children:"\u5bf9\u5916\u670d"}),"\u4e2d\u83b7\u53d6\u6211\u4eec\u9700\u8981\u7684\u6570\u636e\uff0c\n\u5f00\u53d1\u8005\u53ef\u4ee5\u901a\u8fc7\u6269\u5c55 OnExternal \u63a5\u53e3\u5b9e\u73b0\u4e0e\u5bf9\u5916\u670d\u4ea4\u4e92\u3002\n\u6846\u67b6\u901a\u8fc7\u8fd9\u4e00\u6269\u5c55\uff0c\u8f7b\u677e\u5b9e\u73b0\u4e86\u5982\u4e0b\u529f\u80fd"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["ExistUserOnExternal \u67e5\u8be2\u7528\u6237\u662f\u5426\u5728\u7ebf\uff0c\u7c7b\u4f3c",(0,r.jsx)(e.a,{href:"/docs/manual/user_login#prevent_duplicate_login",children:"\u91cd\u590d\u767b\u5f55"}),"\u7684\u68c0\u6d4b"]}),"\n",(0,r.jsxs)(e.li,{children:["ForcedOfflineOnExternal ",(0,r.jsx)(e.a,{href:"/docs/manual/user_login#force_login",children:"\u5f3a\u5236\u7528\u6237\u4e0b\u7ebf"}),"\uff0c\u7c7b\u4f3c\u9876\u53f7\u7684\u529f\u80fd"]}),"\n",(0,r.jsxs)(e.li,{children:["AttachmentUpdateOnExternal ",(0,r.jsx)(e.a,{href:"/docs/manual/flow_context_attachment",children:"\u5143\u9644\u52a0\u4fe1\u606f"})]}),"\n",(0,r.jsxs)(e.li,{children:["SettingUserIdOnExternal ",(0,r.jsx)(e.a,{href:"/docs/manual/user_login#login",children:"\u767b\u5f55"}),"\uff0c\u7ed1\u5b9a userId\u3002"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u73b0\u5728\uff0c\u6211\u4eec\u901a\u8fc7\u4e00\u4e2a\u83b7\u53d6 userIp \u7684\u793a\u4f8b\u6765\u5b66\u4e60\u5982\u4f55\u6269\u5c55\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"example-source-code",children:"Example Source Code"}),"\n",(0,r.jsxs)(e.p,{children:["see ",(0,r.jsx)(e.a,{href:"https://github.com/iohao/ionet-examples",children:"https://github.com/iohao/ionet-examples"})]}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:"path : ionet-cookbook-code"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"UserIpOnExternal"}),"\n",(0,r.jsx)(e.li,{children:"OnExternalAction"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"How-to-Extend",children:"\u5982\u4f55\u6269\u5c55"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"code 4: \u83b7\u53d6\u5f53\u524d\u7528\u6237\u3002"}),"\n",(0,r.jsx)(e.li,{children:"code 7: \u83b7\u53d6\u5f53\u524d\u7528\u6237\u7684 ip\u3002"}),"\n",(0,r.jsx)(e.li,{children:"code 8: \u8bbe\u7f6e\u54cd\u5e94\u503c\u7ed9\u8bf7\u6c42\u7aef\u3002"}),"\n",(0,r.jsx)(e.li,{children:"code 13: \u8bbe\u7f6e\u6269\u5c55\u6807\u8bb0 ExternalTemplateId\u3002"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",metastring:"showLineNumbers",children:"public class UserIpOnExternal implements OnExternal {\n    @Override\n    public void process(byte[] payload, int payloadLength, OnExternalContext context) {\n        // highlight-next-line\n        UserSession userSession = context.getUserSession();\n        ActionErrorEnum.dataNotExist.assertNonNull(userSession);\n        // get userIp\n        String ip = userSession.getIp();\n        // highlight-next-line\n        context.response().setPayload(ip);\n    }\n\n    @Override\n    public int getTemplateId() {\n        // highlight-next-line\n        return MyOnExternalTemplateId.userIp;\n    }\n}\n\npublic interface MyOnExternalTemplateId {\n    /** get userIp */\n    int userIp = 1;\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"config",children:"\u914d\u7f6e"}),"\n",(0,r.jsx)(e.p,{children:"\u5c06\u5b9e\u73b0\u7c7b\u6dfb\u52a0\u5230 OnExternalManager \u4e2d\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",metastring:"showLineNumbers",children:"class OneApplication {\n    static void main() {\n        // highlight-next-line\n        OnExternalManager.register(new UserIpOnExternal());\n        ...\n        new RunOne()\n                ...\n                .startup();\n    }\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"How-to-Use",children:"\u5982\u4f55\u4f7f\u7528"}),"\n",(0,r.jsx)(e.p,{children:"\u901a\u8fc7 callExternal \u7cfb\u5217\u65b9\u6cd5\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\u7528\u6237\u6240\u5728\u7684\u5bf9\u5916\u670d\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"@ActionController(OnExternalCmd.cmd)\npublic final class OnExternalAction {\n    @ActionMethod(OnExternalCmd.userIp)\n    private String getIp(FlowContext flowContext) {\n        // highlight-next-line\n        var externalResponse = flowContext.callExternal(MyOnExternalTemplateId.userIp);\n        return externalResponse.getPayloadAsString();\n    }\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"UserOnlineCountOnExternal",children:"\u7edf\u8ba1\u5728\u7ebf\u4eba\u6570"}),"\n",(0,r.jsx)(e.p,{children:"\u901a\u8fc7\u4e0a\u9762\u7684\u793a\u4f8b\uff0c\u6211\u4eec\u77e5\u9053\u4e86\u5982\u4f55\u83b7\u53d6 userIp\uff0c\u4f46\u793a\u4f8b\u662f\u8bbf\u95ee\u5355\u4e2a\u5bf9\u5916\u670d\u7684\uff0c\u73b0\u5728\u6211\u4eec\u505a\u4e00\u4e2a\u7edf\u8ba1\u5728\u7ebf\u7528\u6237\u7684\u6269\u5c55\u3002\n\u5982\u679c\u6211\u4eec\u542f\u52a8\u4e86\u591a\u4e2a\u5bf9\u5916\u670d\uff0c\u5c31\u9700\u8981\u77e5\u9053\u6bcf\u4e2a\u5bf9\u5916\u670d\u7684\u5f53\u524d\u5728\u7ebf\u4eba\u6570\uff0c\u8fd9\u4e2a\u6269\u5c55\u529f\u80fd\u4f1a\u540c\u65f6\u4e0e\u591a\u4e2a\u5bf9\u5916\u670d\u4ea4\u4e92\u3002"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"code 4: \u83b7\u53d6\u5f53\u524d\u5bf9\u5916\u670d\u7684 UserSessions\u3002"}),"\n",(0,r.jsx)(e.li,{children:"code 6: \u8bbe\u7f6e\u54cd\u5e94\u503c\u7ed9\u8bf7\u6c42\u7aef\u3002"}),"\n",(0,r.jsx)(e.li,{children:"code 11: \u8bbe\u7f6e\u6269\u5c55\u6807\u8bb0 ExternalTemplateId\u3002"}),"\n",(0,r.jsx)(e.li,{children:"code 23: \u5c06\u5b9e\u73b0\u7c7b\u6dfb\u52a0\u5230 OnExternalManager \u4e2d\u3002"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",metastring:"showLineNumbers",children:"public final class UserOnlineCountOnExternal implements OnExternal {\n    @Override\n    public void process(byte[] payload, int payloadLength, OnExternalContext context) {\n        // highlight-next-line\n        UserSessions<?, ?> userSessions = context.userSessions();\n        int countOnline = userSessions.countOnline();\n        // highlight-next-line\n        context.response().setPayload(countOnline);\n    }\n\n    @Override\n    public int getTemplateId() {\n        // highlight-next-line\n        return MyOnExternalTemplateId.userOnlineCount;\n    }\n}\n\npublic interface MyOnExternalTemplateId {\n    /** get userIp */\n    int userIp = 1;\n    int userOnlineCount = 2;\n}\n\nclass OneApplication {\n    static void main() {\n        // highlight-next-line\n        OnExternalManager.register(new UserIpOnExternal());\n        ...\n    }\n}\n"})}),"\n",(0,r.jsx)("br",{}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u5982\u4f55\u4f7f\u7528"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"code 7: \u901a\u8fc7 callCollectExternal \u7cfb\u5217\u65b9\u6cd5\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\u6240\u6709\u5bf9\u5916\u670d\u3002"}),"\n",(0,r.jsx)(e.li,{children:"code 8: \u904d\u5386\u6bcf\u4e2a\u5bf9\u5916\u670d\u7684\u54cd\u5e94\u3002"}),"\n",(0,r.jsx)(e.li,{children:"code 10: \u83b7\u53d6\u5728 UserOnlineCountOnExternal \u4e2d\u8bbe\u7f6e\u7684\u503c\u3002"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",metastring:"showLineNumbers",children:'@ActionController(OnExternalCmd.cmd)\npublic final class OnExternalAction {\n    @ActionMethod(OnExternalCmd.userOnlineCount)\n    private int userOnlineCount(FlowContext flowContext) {\n        int onlineCount = 0;\n\n        var responseCollectExternal = flowContext.callCollectExternal(MyOnExternalTemplateId.userOnlineCount);\n        for (var externalResponse : responseCollectExternal.getResponseList()) {\n            int externalServerId = externalResponse.getExternalServerId();\n            int count = externalResponse.getPayloadAsInt();\n            log.info("externalServerId:{}, count:{}", externalServerId, count);\n\n            onlineCount += count;\n        }\n\n        return onlineCount;\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"Setting-Request-Parameters",children:"\u5982\u4f55\u8bbe\u7f6e\u8bf7\u6c42\u53c2\u6570"}),"\n",(0,r.jsxs)(e.p,{children:["\u4e0a\u9762\u7684\u4e24\u4e2a\u6269\u5c55\u793a\u4f8b\u6ca1\u6709\u6f14\u793a\u8bf7\u6c42\u53c2\u6570\uff0c\u4f46\u5728\u5b9e\u9645\u4e1a\u52a1\u4e2d\uff0c\u6211\u4eec\u53ef\u80fd\u4f1a\u4f20\u4e00\u4e9b\u8bf7\u6c42\u53c2\u6570\u7ed9 OnExternal \u6269\u5c55\u7c7b\u3002\n",(0,r.jsx)(e.strong,{children:"callCollectExternal \u548c callExternal"})," \u65b9\u6cd5\u63d0\u4f9b\u4e86\u91cd\u8f7d\uff0c\u5f00\u53d1\u8005\u53ef\u4ee5\u901a\u8fc7\u91cd\u8f7d\u4f20\u5165\u8bf7\u6c42\u53c2\u6570\uff0c\u5177\u4f53\u53ef\u53c2\u8003\u6e90\u7801 AttachmentUpdateOnExternal\u3002"]}),"\n",(0,r.jsx)("br",{}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u8bbe\u7f6e\u8bf7\u6c42\u53c2\u6570"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",metastring:"showLineNumbers",children:"...\nvoid test() {\n    // highlight-next-line\n    byte[] payload = ...\n    flowContext.callExternal(MyOnExternalTemplateId.xxx, payload);\n}\n"})}),"\n",(0,r.jsx)("br",{}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u83b7\u53d6\u8bf7\u6c42\u53c2\u6570"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",metastring:"showLineNumbers",children:"public final class AttachmentUpdateOnExternal implements OnExternal {\n    @Override\n    public void process(byte[] payload, int payloadLength, OnExternalContext context) {\n        var userSession = context.getUserSession();\n        if (userSession != null) {\n            // highlight-next-line\n            userSession.setAttachment(ByteKit.getPayload(payload, payloadLength));\n        } else {\n            context.response().setError(ActionErrorEnum.dataNotExist);\n        }\n    }\n\n    ...\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"summary",children:"\u5c0f\u7ed3"}),"\n",(0,r.jsx)(e.p,{children:"\u53ea\u8981\u60f3\u8c61\u529b\u8db3\u591f\uff0c\u901a\u8fc7 OnExternal \u63a5\u53e3\u53ef\u4ee5\u505a\u5f88\u591a\u4e8b\u3002\n\u901a\u8fc7\u6269\u5c55\u8be5\u63a5\u53e3\uff0c\u53ef\u4ee5\u4e0e\u5bf9\u5916\u670d\u4ea4\u4e92\u53ca\u83b7\u53d6\u6570\u636e\u3002"})]})}function x(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(d,{...n})}):d(n)}},8453:(n,e,t)=>{t.d(e,{R:()=>s,x:()=>a});var l=t(6540);const r={},i=l.createContext(r);function s(n){const e=l.useContext(i);return l.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:s(n.components),l.createElement(i.Provider,{value:e},n.children)}}}]);